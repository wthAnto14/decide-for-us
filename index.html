<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Decide for Us</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    margin: 0;
    padding-bottom: 70px; /* spazio per menu */
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    background: #fafafa;
    color: #222;
  }
  h1 {
    text-align: center;
    margin-top: 20px;
  }
  #content {
    flex-grow: 1;
    padding: 20px;
    text-align: center;
  }
  input[type="text"] {
    width: 80%;
    max-width: 300px;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  button {
    margin-top: 15px;
    padding: 12px 25px;
    font-size: 18px;
    border: none;
    border-radius: 6px;
    background-color: #2a7d32;
    color: white;
    cursor: pointer;
    user-select: none;
  }
  button:active {
    background-color: #25692a;
  }
  #resultNames, #resultFingers {
    margin-top: 30px;
    font-size: 22px;
    font-weight: bold;
    min-height: 28px;
    color: #2a7d32;
  }
  #areaTouch {
    margin-top: 30px;
    border: 2px dashed #888;
    height: 300px;
    touch-action: none;
    user-select: none;
    position: relative;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    border-radius: 12px;
    background: #fff;
  }
  /* Pallino dito */
  .dot {
    position: absolute;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    opacity: 0.9;
    pointer-events: none;
    box-sizing: border-box;
    transition: background-color 0.4s ease, opacity 0.4s ease;
  }
  /* Colori ciclici */
  .color0 { background-color: #e53935; }  /* rosso */
  .color1 { background-color: #8e24aa; }  /* viola */
  .color2 { background-color: #3949ab; }  /* blu */
  .color3 { background-color: #00897b; }  /* verde acqua */
  .color4 { background-color: #fdd835; }  /* giallo */
  .color5 { background-color: #fb8c00; }  /* arancione */
  .color6 { background-color: #6d4c41; }  /* marrone */

  /* Pallini spenti */
  .inactive {
    background-color: #bbb !important;
    opacity: 0.4 !important;
  }

  /* Cerchio di caricamento intorno al pallino */
  .progress-circle {
    position: absolute;
    top: -10px;
    left: -10px;
    width: 84px;
    height: 84px;
    pointer-events: none;
  }
  svg {
    transform: rotate(-90deg);
  }
  circle {
    fill: none;
    stroke: #2a7d32;
    stroke-width: 4;
    stroke-linecap: round;
    stroke-dasharray: 164.9;
    stroke-dashoffset: 164.9;
    transition: stroke-dashoffset 0.1s linear;
  }

  /* Bottom menu */
  #menu {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px;
    background: white;
    border-top: 1px solid #ccc;
    display: flex;
    justify-content: space-around;
    align-items: center;
    user-select: none;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
  }
  #menu div {
    cursor: pointer;
    font-size: 18px;
    color: #666;
    display: flex;
    flex-direction: column;
    align-items: center;
    transition: color 0.3s ease;
  }
  #menu div.active {
    color: #2a7d32;
    font-weight: bold;
  }
  #menu div span.icon {
    font-size: 28px;
    margin-bottom: 4px;
  }
</style>
</head>
<body>

<h1>Decide for Us</h1>
<div id="content">
  <!-- NAMES MODE -->
  <div id="namesMode" style="display:none;">
    <p>Inserisci i nomi separati da virgole:</p>
    <input type="text" id="namesInput" placeholder="Esempio: Goku, Baddie" />
    <br />
    <button id="pickNameBtn">Scegli!</button>
    <div id="resultNames"></div>
  </div>

  <!-- FINGERS MODE -->
  <div id="fingersMode">
    <p>Appoggia pi√π dita nell‚Äôarea sottostante, la scelta partir√† automaticamente dopo 5 secondi di inattivit√†.</p>
    <div id="areaTouch"></div>
    <div id="resultFingers"></div>
  </div>
</div>

<!-- Bottom menu -->
<div id="menu">
  <div id="menuFingers" class="active" title="Fingers">
    <span class="icon">‚òùÔ∏è</span>
    <span>Fingers</span>
  </div>
  <div id="menuNames" title="Names">
    <span class="icon">üî†</span>
    <span>Names</span>
  </div>
</div>

<script>
  const menuFingers = document.getElementById('menuFingers');
  const menuNames = document.getElementById('menuNames');
  const fingersMode = document.getElementById('fingersMode');
  const namesMode = document.getElementById('namesMode');
  const resultNames = document.getElementById('resultNames');
  const resultFingers = document.getElementById('resultFingers');
  const pickNameBtn = document.getElementById('pickNameBtn');
  const areaTouch = document.getElementById('areaTouch');

  // Active mode tracker
  let activeMode = 'fingers';

  // For touch tracking in Fingers mode
  const activeTouches = new Map();

  // Timer e stato selezione
  let selectionTimer = null;
  const SELECTION_TIME_MS = 5000;
  let selectionDone = false;

  // Colori ciclici per dita
  const colors = ['color0', 'color1', 'color2', 'color3', 'color4', 'color5', 'color6'];

  // Toggle modes
  function setActiveMode(mode) {
    activeMode = mode;
    if (mode === 'fingers') {
      fingersMode.style.display = 'block';
      namesMode.style.display = 'none';
      menuFingers.classList.add('active');
      menuNames.classList.remove('active');
      resultNames.textContent = '';
      resultFingers.textContent = '';
      clearTouchDots();
      selectionDone = false;
      resetAllProgressCircles();
    } else {
      fingersMode.style.display = 'none';
      namesMode.style.display = 'block';
      menuFingers.classList.remove('active');
      menuNames.classList.add('active');
      resultNames.textContent = '';
      resultFingers.textContent = '';
      clearTouchDots();
      clearTimer();
      selectionDone = false;
      resetAllProgressCircles();
    }
  }

  menuFingers.addEventListener('click', () => setActiveMode('fingers'));
  menuNames.addEventListener('click', () => setActiveMode('names'));

  // Gestione touch area per dita
  areaTouch.addEventListener('touchstart', (e) => {
    if (activeMode !== 'fingers') return;
    if(selectionDone) {
      clearTouchDots();
      selectionDone = false;
      resetAllProgressCircles();
    }
    for (const touch of e.changedTouches) {
      const dot = document.createElement('div');
      dot.classList.add('dot');
      const colorClass = colors[activeTouches.size % colors.length];
      dot.classList.add(colorClass);
      dot.style.left = (touch.pageX - 35) + 'px';
      dot.style.top = (touch.pageY - 35) + 'px';

      const progressCircle = createProgressCircle();
      dot.appendChild(progressCircle);

      document.body.appendChild(dot);
      activeTouches.set(touch.identifier, {x: touch.pageX, y: touch.pageY, element: dot, colorClass, progressCircle});
    }
    resetTimer();
    e.preventDefault();
  }, {passive:false});

  areaTouch.addEventListener('touchmove', (e) => {
    if (activeMode !== 'fingers') return;
    for (const touch of e.changedTouches) {
      const data = activeTouches.get(touch.identifier);
      if (data) {
        data.x = touch.pageX;
        data.y = touch.pageY;
        data.element.style.left = (touch.pageX - 35) + 'px';
        data.element.style.top = (touch.pageY - 35) + 'px';
      }
    }
    // Non resettare il timer durante il movimento
    e.preventDefault();
  }, {passive:false});

  areaTouch.addEventListener('touchend', (e) => {
    if (activeMode !== 'fingers') return;
    for (const touch of e.changedTouches) {
      const data = activeTouches.get(touch.identifier);
      if (data) {
        document.body.removeChild(data.element);
        activeTouches.delete(touch.identifier);
      }
    }
    resetTimer();
    e.preventDefault();
  }, {passive:false});

  areaTouch.addEventListener('touchcancel', (e) => {
    if (activeMode !== 'fingers') return;
    for (const touch of e.changedTouches) {
      const data = activeTouches.get(touch.identifier);
      if (data) {
        document.body.removeChild(data.element);
        activeTouches.delete(touch.identifier);
      }
    }
    resetTimer();
    e.preventDefault();
  }, {passive:false});

  // Timer reset e start
  function resetTimer() {
    clearTimer();
    if (activeTouches.size === 0) {
      resultFingers.textContent = 'Appoggia almeno un dito.';
      return;
    }
    resultFingers.textContent = `Dita poggiate: ${activeTouches.size}. Scelta tra 5 secondi...`;
    startProgressAnimation();
    selectionTimer = setTimeout(() => {
      scegliDito();
    }, SELECTION_TIME_MS);
  }

  function clearTimer() {
    if (selectionTimer) {
      clearTimeout(selectionTimer);
      selectionTimer = null;
    }
  }

  // Scegli il dito casuale, mostra risultato e colora i pallini
  function scegliDito() {
    if (activeTouches.size === 0) {
      resultFingers.textContent = 'Nessun dito poggiato!';
      selectionDone = false;
      resetAllProgressCircles();
      return;
    }
    selectionDone = true;
    clearTimer();

    const touchesArray = Array.from(activeTouches.keys());
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const idx = array[0] % touchesArray.length;
    const chosenId = touchesArray[idx];

    activeTouches.forEach(({element, colorClass, progressCircle}, id) => {
      if (id === chosenId) {
        element.classList.remove('inactive');
        element.style.opacity = '1';
        animateProgressCircle(progressCircle, SELECTION_TIME_MS, true);
      } else {
        element.classList.add('inactive');
        element.style.opacity = '0.4';
        resetProgressCircle(progressCircle);
      }
    });

    const pos = activeTouches.get(chosenId);
    resultFingers.textContent = `Dito scelto: ID ${chosenId + 1} (X:${pos.x.toFixed(0)}, Y:${pos.y.toFixed(0)})`;
  }

  // Crea SVG per il cerchio di progresso
  function createProgressCircle() {
    const ns = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(ns, "svg");
    svg.setAttribute("class", "progress-circle");
    svg.setAttribute("width", "84");
    svg.setAttribute("height", "84");
    const circleBg = document.createElementNS(ns, "circle");
    circleBg.setAttribute("r", "26");
    circleBg.setAttribute("cx", "42");
    circleBg.setAttribute("cy", "42");
    circleBg.setAttribute("stroke", "#ddd");
    circleBg.setAttribute("stroke-width", "4");
    circleBg.setAttribute("fill", "none");
    svg.appendChild(circleBg);
    const circle = document.createElementNS(ns, "circle");
    circle.setAttribute("r", "26");
    circle.setAttribute("cx", "42");
    circle.setAttribute("cy", "42");
    circle.setAttribute("stroke-width", "4");
    circle.setAttribute("fill", "none");
    circle.setAttribute("stroke-linecap", "round");
    circle.setAttribute("stroke-dasharray", "164.9");
    circle.setAttribute("stroke-dashoffset", "164.9");
    circle.setAttribute("stroke", "#2a7d32");
    svg.appendChild(circle);
    return svg;
  }

  // Anima il progresso del cerchio
  function animateProgressCircle(svg, duration, finish = false) {
    if (!svg) return;
    const circle = svg.querySelectorAll('circle')[1];
    if (!circle) return;

    let start = null;
    if (finish) {
      circle.style.transition = 'stroke-dashoffset 0.5s ease-out';
      circle.style.strokeDashoffset = '0';
      return;
    }

    circle.style.transition = 'none';
    circle.style.strokeDashoffset = '164.9';

    function step(timestamp) {
      if (!start) start = timestamp;
      const elapsed = timestamp - start;
      const progress = Math.min(elapsed / duration, 1);
      circle.style.strokeDashoffset = (164.9 * (1 - progress)).toFixed(1);
      if (progress < 1) {
        requestAnimationFrame(step);
      }
    }
    requestAnimationFrame(step);
  }

  // Reset animazione cerchi di tutti i pallini
  function resetAllProgressCircles() {
    activeTouches.forEach(({progressCircle}) => {
      resetProgressCircle(progressCircle);
    });
  }
  function resetProgressCircle(svg) {
    if (!svg) return;
    const circle = svg.querySelectorAll('circle')[1];
    if (!circle) return;
    circle.style.transition = 'none';
    circle.style.strokeDashoffset = '164.9';
  }

  // Pulisce i pallini e resetta dati
  function clearTouchDots() {
    activeTouches.forEach(({element}) => {
      if (element.parentNode) element.parentNode.removeChild(element);
    });
    activeTouches.clear();
  }

  // Names mode: pick a random name
  pickNameBtn.addEventListener('click', () => {
    const input = document.getElementById('namesInput').value;
    const nomi = input.split(',').map(n => n.trim()).filter(n => n.length > 0);
    if (nomi.length < 2) {
      resultNames.textContent = 'Inserisci almeno 2 nomi.';
      return;
    }
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const index = array[0] % nomi.length;
    resultNames.textContent = `üëâ Scelto: ${nomi[index]}`;
  });

  // Imposta modalit√† di default
  setActiveMode('fingers');
</script>
</body>
</html>
