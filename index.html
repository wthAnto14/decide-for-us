<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Decide for Us</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #000;
      color: white;
      overflow: hidden;
      user-select: none;
    }

    #header {
      text-align: center;
      font-size: 2.8rem;
      font-weight: 900;
      padding: 20px 0 10px 0;
      background: linear-gradient(90deg,
        #FF0000,
        #FF7F00,
        #FFFF00,
        #00FF00,
        #0000FF,
        #4B0082,
        #8B00FF);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      letter-spacing: 2px;
      user-select: none;
    }

    #areaTouch {
      width: 100vw;
      height: 65vh;
      max-height: 500px;
      margin: 0 auto;
      background: #111;
      position: relative;
      border-radius: 10px;
      box-shadow: 0 0 15px 3px rgba(255 255 255 / 0.1);
      touch-action: none;
    }

    .dot {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 12px 4px rgba(255 255 255 / 0.3);
      transition: opacity 0.4s ease;
      animation: glowPulse 2.5s infinite alternate;
      user-select: none;
      cursor: default;
    }
    .dot.red    { background: #FF0000; box-shadow: 0 0 15px #FF0000; }
    .dot.orange { background: #FF7F00; box-shadow: 0 0 15px #FF7F00; }
    .dot.yellow { background: #FFFF00; box-shadow: 0 0 15px #FFFF00; }
    .dot.green  { background: #00FF00; box-shadow: 0 0 15px #00FF00; }
    .dot.blue   { background: #0000FF; box-shadow: 0 0 15px #0000FF; }
    .dot.indigo { background: #4B0082; box-shadow: 0 0 15px #4B0082; }
    .dot.purple { background: #8B00FF; box-shadow: 0 0 15px #8B00FF; }

    @keyframes glowPulse {
      0% {
        box-shadow: 0 0 12px 4px rgba(255 255 255 / 0.3);
      }
      100% {
        box-shadow: 0 0 25px 8px rgba(255 255 255 / 0.7);
      }
    }

    .dot svg {
      width: 80px;
      height: 80px;
      position: absolute;
      transform: rotate(-90deg);
    }

    .dot svg circle.bg {
      stroke: #444;
      stroke-width: 6;
    }

    .dot svg circle.fg {
      stroke-width: 6;
      stroke-linecap: round;
      stroke-dasharray: 164.9;
      stroke-dashoffset: 164.9;
      stroke: white;
      transition: stroke-dashoffset 0.3s linear;
    }

    #menu {
      height: 70px;
      background: #222;
      color: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      font-size: 20px;
      font-weight: 700;
      user-select: none;
    }

    #menu div {
      cursor: pointer;
      padding: 12px 20px;
      border-radius: 12px;
      user-select: none;
      transition: background-color 0.3s ease;
    }

    #menu .active {
      background-color: #555;
    }

    #namesInput, #pickNameBtn {
      margin: 10px;
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      outline: none;
      box-shadow: 0 0 10px rgba(255 255 255 / 0.2);
      user-select: none;
    }

    #namesInput {
      width: 70%;
      max-width: 400px;
      color: #000;
    }

    #pickNameBtn {
      background-color: #444;
      color: white;
      cursor: pointer;
      user-select: none;
    }

    #pickNameBtn:hover {
      background-color: #666;
    }

    #fingersArea, #namesArea {
      padding: 15px;
      background: #111;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      text-align: center;
      user-select: none;
    }

    #countdown {
      font-size: 20px;
      margin-top: 10px;
      font-weight: 600;
      color: white;
    }
  </style>
</head>
<body>

<div id="header">Decide For Us</div>

<div id="areaTouch"></div>

<div id="fingersArea">
  <div id="resultFingers">Appoggia almeno 2 dita per iniziare la scelta.</div>
  <div id="countdown"></div>
</div>

<div id="namesArea">
  <input type="text" id="namesInput" placeholder="Inserisci nomi separati da virgola" />
  <button id="pickNameBtn">Scegli un nome</button>
  <div id="resultNames"></div>
</div>

<div id="menu">
  <div id="modeFingers">‚òùÔ∏è Fingers</div>
  <div id="modeNames">üî† Names</div>
</div>

<script>
  const areaTouch = document.getElementById('areaTouch');
  const resultFingers = document.getElementById('resultFingers');
  const countdownEl = document.getElementById('countdown');
  const pickNameBtn = document.getElementById('pickNameBtn');
  const resultNames = document.getElementById('resultNames');
  const modeFingers = document.getElementById('modeFingers');
  const modeNames = document.getElementById('modeNames');
  const fingersArea = document.getElementById('fingersArea');
  const namesArea = document.getElementById('namesArea');

  const SELECTION_TIME_MS = 5000;
  const colors = ['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'purple'];
  let activeTouches = new Map();
  let selectionTimer = null;
  let countdownInterval = null;
  let selectionDone = false;
  let activeMode = 'fingers';
  let previousTouchCount = 0;

  function setActiveMode(mode) {
    activeMode = mode;
    if (mode === 'fingers') {
      fingersArea.style.display = 'block';
      namesArea.style.display = 'none';
      areaTouch.style.display = 'block';
      modeFingers.classList.add('active');
      modeNames.classList.remove('active');
    } else {
      fingersArea.style.display = 'none';
      namesArea.style.display = 'block';
      areaTouch.style.display = 'none';
      modeFingers.classList.remove('active');
      modeNames.classList.add('active');
    }
  }

  modeFingers.addEventListener('click', () => setActiveMode('fingers'));
  modeNames.addEventListener('click', () => setActiveMode('names'));

  function clearTimer() {
    clearTimeout(selectionTimer);
    clearInterval(countdownInterval);
    selectionTimer = null;
    countdownInterval = null;
    resetAllProgressCircles();
  }

  function createProgressCircle() {
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    const bg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    const fg = document.createElementNS("http://www.w3.org/2000/svg", "circle");

    bg.classList.add('bg');
    fg.classList.add('fg');

    [bg, fg].forEach(c => {
      c.setAttribute("cx", "40");
      c.setAttribute("cy", "40");
      c.setAttribute("r", "26.25");
    });

    svg.appendChild(bg);
    svg.appendChild(fg);
    return svg;
  }

  function startProgressAnimation() {
    const duration = SELECTION_TIME_MS;
    const start = performance.now();

    activeTouches.forEach(({progressCircle}) => {
      animateProgress(progressCircle.querySelectorAll('circle')[1], duration, start);
    });
  }

  function animateProgress(circle, duration, start) {
    function step(timestamp) {
      const elapsed = timestamp - start;
      const progress = Math.min(elapsed / duration, 1);
      circle.style.strokeDashoffset = 164.9 * (1 - progress);
      if (elapsed < duration) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function resetProgressCircle(svg) {
    if (!svg) return;
    const circle = svg.querySelectorAll('circle')[1];
    if (!circle) return;
    circle.style.transition = 'stroke-dashoffset 0.3s ease';
    circle.style.strokeDashoffset = '164.9';
  }

  function resetAllProgressCircles() {
    activeTouches.forEach(({progressCircle}) => {
      resetProgressCircle(progressCircle);
    });
  }

  function clearTouchDots() {
    activeTouches.forEach(({element}) => {
      if (areaTouch.contains(element)) areaTouch.removeChild(element);
    });
    activeTouches.clear();
  }

  function scegliDito() {
    if (activeTouches.size < 2) return;
    const keys = Array.from(activeTouches.keys());
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const idx = array[0] % keys.length;
    const winner = keys[idx];
    activeTouches.forEach((data, id) => {
      if (id !== winner) {
        data.element.style.opacity = '0.3';
        data.element.style.animation = 'none';
      } else {
        data.element.style.opacity = '1';
      }
    });
    resultFingers.textContent = 'Dito scelto!';
    selectionDone = true;
  }

  function resetTimer() {
    if (selectionTimer || countdownInterval) {
      clearTimer();
    }

    if (activeTouches.size < 2) {
      resultFingers.textContent = 'Appoggia almeno 2 dita per iniziare la scelta.';
      countdownEl.textContent = '';
      return;
    }

    resultFingers.textContent = `Dita poggiate: ${activeTouches.size}. Scelta tra 5 secondi...`;
    let secondsLeft = SELECTION_TIME_MS / 1000;
    countdownEl.textContent = `Tempo rimasto: ${secondsLeft} s`;

    startProgressAnimation();

    countdownInterval = setInterval(() => {
      secondsLeft--;
      countdownEl.textContent = `Tempo rimasto: ${secondsLeft} s`;
      if (secondsLeft <= 0) {
        clearInterval(countdownInterval);
        countdownEl.textContent = '';
        scegliDito();
      }
    }, 1000);

    selectionTimer = setTimeout(() => {
      clearInterval(countdownInterval);
      countdownEl.textContent = '';
      scegliDito();
    }, SELECTION_TIME_MS);
  }

  // Touch Events
  ['touchstart', 'touchend', 'touchcancel'].forEach(eventType => {
    areaTouch.addEventListener(eventType, (e) => {
      if (activeMode !== 'fingers') return;

      if (eventType === 'touchstart' && selectionDone) {
        clearTouchDots();
        resetAllProgressCircles();
        selectionDone = false;
      }

      for (const touch of e.changedTouches) {
        if (eventType === 'touchstart') {
          const dot = document.createElement('div');
          dot.classList.add('dot');
          const colorClass = colors[activeTouches.size % colors.length];
          dot.classList.add(colorClass);
          dot.style.left = (touch.pageX - 35) + 'px';
          dot.style.top = (touch.pageY - 35) + 'px';

          const progressCircle = createProgressCircle();
          dot.appendChild(progressCircle);

          areaTouch.appendChild(dot);
          activeTouches.set(touch.identifier, {
            x: touch.pageX,
            y: touch.pageY,
            element: dot,
            colorClass,
            progressCircle
          });
        } else {
          const data = activeTouches.get(touch.identifier);
          if (data) {
            areaTouch.removeChild(data.element);
            activeTouches.delete(touch.identifier);
          }
        }
      }

      const currentTouchCount = activeTouches.size;
      if (currentTouchCount >= 2) {
        if (previousTouchCount !== currentTouchCount) {
          resetTimer();
        }
      } else {
        clearTimer();
        resultFingers.textContent = 'Appoggia almeno 2 dita per iniziare la scelta.';
        countdownEl.textContent = '';
      }
      previousTouchCount = currentTouchCount;

      e.preventDefault();
    }, { passive: false });
  });

  areaTouch.addEventListener('touchmove', (e) => {
    if (activeMode !== 'fingers') return;
    const rect = areaTouch.getBoundingClientRect();

    for (const touch of e.changedTouches) {
      const data = activeTouches.get(touch.identifier);
      if (data) {
        let x = touch.pageX;
        let y = touch.pageY;

        x = Math.max(rect.left + 35, Math.min(x, rect.right - 35));
        y = Math.max(rect.top + 35, Math.min(y, rect.bottom - 35));

        data.x = x;
        data.y = y;
        data.element.style.left = (x - 35) + 'px';
        data.element.style.top = (y - 35) + 'px';
      }
    }
    e.preventDefault();
  }, { passive: false });

  pickNameBtn.addEventListener('click', () => {
    if (activeMode !== 'names') return;
    const input = document.getElementById('namesInput').value.trim();
    if (!input) {
      resultNames.textContent = 'Inserisci almeno un nome.';
      return;
    }
    const names = input.split(',').map(n => n.trim()).filter(n => n.length > 0);
    if (names.length === 0) {
      resultNames.textContent = 'Inserisci almeno un nome valido.';
      return;
    }
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const idx = array[0] % names.length;
    resultNames.textContent = `Nome scelto: ${names[idx]}`;
  });

  setActiveMode('fingers');
</script>

</body>
</html>
