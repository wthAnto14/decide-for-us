<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Decide for Us</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background-color: #000;
      color: white;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
    }

    #header {
      text-align: center;
      font-size: 2.8rem;
      font-weight: 900;
      padding: 20px 0 10px 0;
      background: linear-gradient(90deg,
        #FF0000, #FF7F00, #FFFF00, #00FF00,
        #0000FF, #4B0082, #8B00FF);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      letter-spacing: 2px;
    }

    #areaTouch {
      width: 100vw;
      height: 65vh;
      max-height: 500px;
      margin: 0 auto;
      background: #111;
      position: relative;
      border-radius: 10px;
      box-shadow: 0 0 15px 3px rgba(255 255 255 / 0.1);
      touch-action: none;
    }

    .dot {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 12px 4px rgba(255 255 255 / 0.3);
      transition: opacity 0.4s ease, transform 0.3s ease;
      animation: glowPulse 2.5s infinite alternate;
      cursor: default;
      transform: translate(-50%, -50%);
    }

    .dot.red    { background: #FF0000; box-shadow: 0 0 15px #FF0000; }
    .dot.orange { background: #FF7F00; box-shadow: 0 0 15px #FF7F00; }
    .dot.yellow { background: #FFFF00; box-shadow: 0 0 15px #FFFF00; }
    .dot.green  { background: #00FF00; box-shadow: 0 0 15px #00FF00; }
    .dot.blue   { background: #0000FF; box-shadow: 0 0 15px #0000FF; }
    .dot.indigo { background: #4B0082; box-shadow: 0 0 15px #4B0082; }
    .dot.purple { background: #8B00FF; box-shadow: 0 0 15px #8B00FF; }

    @keyframes glowPulse {
      from { box-shadow: 0 0 12px 4px rgba(255 255 255 / 0.3); }
      to   { box-shadow: 0 0 25px 8px rgba(255 255 255 / 0.7); }
    }

    .dot svg {
      width: 80px;
      height: 80px;
      position: absolute;
      transform: rotate(-90deg);
    }

    .dot svg circle.bg {
      stroke: #444;
      stroke-width: 6;
      fill: transparent;
    }

    .dot svg circle.fg {
      stroke-width: 6;
      stroke-linecap: round;
      stroke: white;
      fill: transparent;
    }

    #menu {
      height: 70px;
      background: #222;
      color: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      font-size: 20px;
      font-weight: 700;
    }

    #menu div {
      cursor: pointer;
      padding: 12px 20px;
      border-radius: 12px;
      transition: background-color 0.3s ease;
    }

    #menu .active {
      background-color: #555;
    }

    #namesInput, #pickNameBtn {
      margin: 10px;
      padding: 12px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      outline: none;
      box-shadow: 0 0 10px rgba(255 255 255 / 0.2);
    }

    #namesInput {
      width: 70%;
      max-width: 400px;
      color: #000;
    }

    #pickNameBtn {
      background-color: #444;
      color: white;
      cursor: pointer;
    }

    #pickNameBtn:hover {
      background-color: #666;
    }

    #fingersArea, #namesArea {
      padding: 15px;
      background: #111;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      text-align: center;
    }

    #countdown {
      font-size: 20px;
      margin-top: 10px;
      font-weight: 600;
      color: white;
    }
  </style>
</head>
<body>

<div id="header">Decide For Us</div>

<div id="areaTouch"></div>

<div id="fingersArea">
  <div id="resultFingers">Appoggia almeno 2 dita per iniziare la scelta.</div>
  <div id="countdown"></div>
</div>

<div id="namesArea" style="display: none;">
  <input type="text" id="namesInput" placeholder="Inserisci nomi separati da virgola" />
  <button id="pickNameBtn">Scegli un nome</button>
  <div id="resultNames"></div>
</div>

<div id="menu">
  <div id="modeFingers" class="active">‚òùÔ∏è Fingers</div>
  <div id="modeNames">üî† Names</div>
</div>

<script>
  const areaTouch = document.getElementById('areaTouch');
  const resultFingers = document.getElementById('resultFingers');
  const countdownEl = document.getElementById('countdown');
  const pickNameBtn = document.getElementById('pickNameBtn');
  const resultNames = document.getElementById('resultNames');
  const modeFingers = document.getElementById('modeFingers');
  const modeNames = document.getElementById('modeNames');
  const fingersArea = document.getElementById('fingersArea');
  const namesArea = document.getElementById('namesArea');
  const namesInput = document.getElementById('namesInput');

  const SELECTION_TIME_MS = 3000;
  const DOT_SIZE = 70;
  const CIRCLE_RADIUS = 26.25;
  const CIRCLE_CIRCUMFERENCE = 2 * Math.PI * CIRCLE_RADIUS;
  const COLORS = ['red', 'orange', 'yellow', 'green', 'blue', 'indigo', 'purple'];

  let activeTouches = new Map();
  let selectionTimer = null;
  let countdownInterval = null;
  let selectionDone = false;
  let activeMode = 'fingers';
  let previousTouchCount = 0;
  let winnerTouchId = null;

  function setActiveMode(mode) {
    activeMode = mode;
    if (mode === 'fingers') {
      fingersArea.style.display = 'block';
      namesArea.style.display = 'none';
      areaTouch.style.display = 'block';
      areaTouch.style.backgroundColor = '#111';
      modeFingers.classList.add('active');
      modeNames.classList.remove('active');
      resetFingersGame();
    } else {
      fingersArea.style.display = 'none';
      namesArea.style.display = 'block';
      areaTouch.style.display = 'none';
      modeFingers.classList.remove('active');
      modeNames.classList.add('active');
    }
  }

  function clearTimer() {
    clearTimeout(selectionTimer);
    clearInterval(countdownInterval);
    selectionTimer = null;
    countdownInterval = null;
    resetAllProgressCircles();
  }

  function createProgressCircle() {
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    const bg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    const fg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    [bg, fg].forEach(c => {
      c.setAttribute("cx", "40");
      c.setAttribute("cy", "40");
      c.setAttribute("r", CIRCLE_RADIUS);
    });
    fg.classList.add('fg');
    bg.classList.add('bg');
    fg.style.strokeDasharray = CIRCLE_CIRCUMFERENCE;
    fg.style.strokeDashoffset = CIRCLE_CIRCUMFERENCE;
    svg.appendChild(bg);
    svg.appendChild(fg);
    return svg;
  }

  function startProgressAnimation() {
    const duration = SELECTION_TIME_MS;
    const start = performance.now();
    activeTouches.forEach(({ progressCircle }) => {
      if (progressCircle) {
        const circle = progressCircle.querySelector('.fg');
        animateProgress(circle, duration, start);
      }
    });
  }

  function animateProgress(circle, duration, start) {
    function step(timestamp) {
      const elapsed = timestamp - start;
      const progress = Math.min(elapsed / duration, 1);
      circle.style.strokeDashoffset = CIRCLE_CIRCUMFERENCE * (1 - progress);
      if (elapsed < duration) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function resetProgressCircle(svg) {
    if (!svg) return;
    const circle = svg.querySelector('.fg');
    if (!circle) return;
    circle.style.transition = 'none';
    circle.style.strokeDashoffset = CIRCLE_CIRCUMFERENCE;
  }

  function resetAllProgressCircles() {
    activeTouches.forEach(({ progressCircle }) => {
      resetProgressCircle(progressCircle);
    });
  }

  function resetFingersGame() {
    clearTimer();
    while (areaTouch.firstChild) {
      areaTouch.removeChild(areaTouch.firstChild);
    }
    activeTouches.clear();
    resultFingers.textContent = 'Appoggia almeno 2 dita per iniziare la scelta.';
    countdownEl.textContent = '';
    selectionDone = false;
    previousTouchCount = 0;
    winnerTouchId = null;
    areaTouch.style.backgroundColor = '#111';
  }

  function selectFinger() {
    if (activeTouches.size < 2) return;
    selectionDone = true;
    const keys = Array.from(activeTouches.keys());
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const winnerIndex = array[0] % keys.length;
    winnerTouchId = keys[winnerIndex];

    activeTouches.forEach((data, id) => {
      if (id !== winnerTouchId) {
        areaTouch.removeChild(data.element);
        activeTouches.delete(id);
      } else {
        const dotColor = getComputedStyle(data.element).backgroundColor;
        areaTouch.style.backgroundColor = dotColor;
        data.element.style.opacity = '1';
        data.element.style.animation = 'none';
        data.element.style.transform = 'translate(-50%, -50%) scale(1.2)';
      }
    });

    resultFingers.textContent = 'Dito scelto!';
  }

  function startSelectionProcess() {
    if (selectionTimer || activeTouches.size < 2) return;
    resultFingers.textContent = `Dita poggiate: ${activeTouches.size}. Scelta tra ${SELECTION_TIME_MS / 1000} secondi...`;
    let secondsLeft = SELECTION_TIME_MS / 1000;
    countdownEl.textContent = `Tempo rimasto: ${secondsLeft} s`;
    startProgressAnimation();

    countdownInterval = setInterval(() => {
      secondsLeft--;
      countdownEl.textContent = `Tempo rimasto: ${secondsLeft > 0 ? secondsLeft : 0} s`;
    }, 1000);

    selectionTimer = setTimeout(() => {
      clearInterval(countdownInterval);
      countdownEl.textContent = '';
      selectFinger();
    }, SELECTION_TIME_MS);
  }

  function handleTouchStart(e) {
    if (activeMode !== 'fingers') return;
    e.preventDefault();
    if (selectionDone) resetFingersGame();
    const rect = areaTouch.getBoundingClientRect();

    for (const touch of e.changedTouches) {
      const dot = document.createElement('div');
      dot.classList.add('dot');
      dot.classList.add(COLORS[activeTouches.size % COLORS.length]);
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      dot.style.left = `${x}px`;
      dot.style.top = `${y}px`;
      const progressCircle = createProgressCircle();
      dot.appendChild(progressCircle);
      areaTouch.appendChild(dot);
      activeTouches.set(touch.identifier, { element: dot, progressCircle });
    }

    updateTouchState();
  }

  function handleTouchEnd(e) {
    if (activeMode !== 'fingers') return;
    e.preventDefault();
    for (const touch of e.changedTouches) {
      const data = activeTouches.get(touch.identifier);
      if (data) {
        areaTouch.removeChild(data.element);
        activeTouches.delete(touch.identifier);
      }

      // Se il vincitore ha sollevato il dito, reset
      if (selectionDone && touch.identifier === winnerTouchId) {
        setTimeout(() => {
          areaTouch.style.backgroundColor = '#111';
          resetFingersGame();
        }, 100);
      }
    }

    if (selectionDone) return;
    updateTouchState();
  }

  function handleTouchMove(e) {
    if (activeMode !== 'fingers' || (selectionDone && winnerTouchId === null)) return;
    e.preventDefault();
    const rect = areaTouch.getBoundingClientRect();

    for (const touch of e.changedTouches) {
      const data = activeTouches.get(touch.identifier);
      if (!data) continue;
      if (selectionDone && touch.identifier !== winnerTouchId) continue;
      let x = touch.clientX - rect.left;
      let y = touch.clientY - rect.top;
      const r = DOT_SIZE / 2;
      x = Math.max(r, Math.min(x, rect.width - r));
      y = Math.max(r, Math.min(y, rect.height - r));
      data.element.style.left = `${x}px`;
      data.element.style.top = `${y}px`;
    }
  }

  function updateTouchState() {
    const current = activeTouches.size;
    if (previousTouchCount !== current && !selectionDone) {
      clearTimer();
      if (current >= 2) startSelectionProcess();
      else {
        resultFingers.textContent = 'Appoggia almeno 2 dita per iniziare la scelta.';
        countdownEl.textContent = '';
      }
    }
    previousTouchCount = current;
  }

  function pickName() {
    if (activeMode !== 'names') return;
    const input = namesInput.value.trim();
    if (!input) {
      resultNames.textContent = 'Inserisci almeno un nome.';
      return;
    }
    const names = input.split(',').map(n => n.trim()).filter(n => n);
    if (names.length === 0) {
      resultNames.textContent = 'Inserisci almeno un nome valido.';
      return;
    }
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    resultNames.textContent = `Nome scelto: ${names[array[0] % names.length]}`;
  }

  areaTouch.addEventListener('touchstart', handleTouchStart, { passive: false });
  areaTouch.addEventListener('touchend', handleTouchEnd, { passive: false });
  areaTouch.addEventListener('touchcancel', handleTouchEnd, { passive: false });
  areaTouch.addEventListener('touchmove', handleTouchMove, { passive: false });
  pickNameBtn.addEventListener('click', pickName);
  modeFingers.addEventListener('click', () => setActiveMode('fingers'));
  modeNames.addEventListener('click', () => setActiveMode('names'));
  setActiveMode('fingers');
</script>

</body>
</html>
