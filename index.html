<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Decide for Us</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      overflow: hidden;
    }
    #areaTouch {
      width: 100vw;
      height: calc(100vh - 80px);
      background: #f0f0f0;
      position: relative;
    }
    .dot {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      position: absolute;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .dot.red    { background: #ff4d4d; }
    .dot.blue   { background: #4d79ff; }
    .dot.green  { background: #4dff88; }
    .dot.orange { background: #ffaa00; }
    .dot.purple { background: #cc66ff; }
    .dot.cyan   { background: #00e6e6; }
    .dot.yellow { background: #ffff66; }

    .dot svg {
      position: absolute;
      width: 80px;
      height: 80px;
      transform: rotate(-90deg);
    }
    .dot svg circle {
      fill: none;
      stroke-width: 6;
    }
    .dot svg circle.bg {
      stroke: #ccc;
    }
    .dot svg circle.fg {
      stroke: #333;
      stroke-dasharray: 164.9;
      stroke-dashoffset: 164.9;
    }

    #menu {
      height: 80px;
      background: #222;
      color: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      font-size: 18px;
      z-index: 1000; /* üëà aggiungi questo */
      position: relative; /* üëà e questo per fare funzionare lo z-index */
    }
    #menu div {
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
    }
    #menu .active {
      background: #555;
    }

    #namesInput, #pickNameBtn {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
    }
    #namesArea, #fingersArea {
      display: none;
      padding: 10px;
      background: #fff;
    }
    #countdown {
      font-size: 18px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div id="areaTouch"></div>

<div id="fingersArea">
  <div id="resultFingers">Appoggia almeno 2 dita per iniziare la scelta.</div>
  <div id="countdown"></div>
</div>

<div id="namesArea">
  <input type="text" id="namesInput" placeholder="Inserisci nomi separati da virgola">
  <button id="pickNameBtn">Scegli un nome</button>
  <div id="resultNames"></div>
</div>

<div id="menu">
  <div id="modeFingers">‚òùÔ∏è Fingers</div>
  <div id="modeNames">üî† Names</div>
</div>

<script>
  const areaTouch = document.getElementById('areaTouch');
  const resultFingers = document.getElementById('resultFingers');
  const countdownEl = document.getElementById('countdown');
  const pickNameBtn = document.getElementById('pickNameBtn');
  const resultNames = document.getElementById('resultNames');
  const modeFingers = document.getElementById('modeFingers');
  const modeNames = document.getElementById('modeNames');
  const fingersArea = document.getElementById('fingersArea');
  const namesArea = document.getElementById('namesArea');

  const SELECTION_TIME_MS = 5000;
  const colors = ['red', 'blue', 'green', 'orange', 'purple', 'cyan', 'yellow'];
  let activeTouches = new Map();
  let selectionTimer = null;
  let countdownInterval = null;
  let selectionDone = false;
  let activeMode = 'fingers';
  let previousTouchCount = 0;

  function setActiveMode(mode) {
    activeMode = mode;
    if (mode === 'fingers') {
      fingersArea.style.display = 'block';
      namesArea.style.display = 'none';
      modeFingers.classList.add('active');
      modeNames.classList.remove('active');
    } else {
      fingersArea.style.display = 'none';
      namesArea.style.display = 'block';
      modeFingers.classList.remove('active');
      modeNames.classList.add('active');
    }
  }

  modeFingers.addEventListener('click', () => setActiveMode('fingers'));
  modeNames.addEventListener('click', () => setActiveMode('names'));

  function clearTimer() {
    clearTimeout(selectionTimer);
    clearInterval(countdownInterval);
    selectionTimer = null;
    countdownInterval = null;
    resetAllProgressCircles();
  }

  function createProgressCircle() {
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    const bg = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    const fg = document.createElementNS("http://www.w3.org/2000/svg", "circle");

    bg.classList.add('bg');
    fg.classList.add('fg');

    [bg, fg].forEach(c => {
      c.setAttribute("cx", "40");
      c.setAttribute("cy", "40");
      c.setAttribute("r", "26.25");
    });

    svg.appendChild(bg);
    svg.appendChild(fg);
    return svg;
  }

  function startProgressAnimation() {
    const duration = SELECTION_TIME_MS;
    const start = performance.now();

    activeTouches.forEach(({progressCircle}) => {
      animateProgress(progressCircle.querySelectorAll('circle')[1], duration, start);
    });
  }

  function animateProgress(circle, duration, start) {
    function step(timestamp) {
      const elapsed = timestamp - start;
      const progress = Math.min(elapsed / duration, 1);
      circle.style.strokeDashoffset = 164.9 * (1 - progress);
      if (elapsed < duration) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  function resetProgressCircle(svg) {
    if (!svg) return;
    const circle = svg.querySelectorAll('circle')[1];
    if (!circle) return;
    circle.style.transition = 'stroke-dashoffset 0.3s ease';
    circle.style.strokeDashoffset = '164.9';
  }

  function resetAllProgressCircles() {
    activeTouches.forEach(({progressCircle}) => {
      resetProgressCircle(progressCircle);
    });
  }

  function clearTouchDots() {
    activeTouches.forEach(({element}) => {
      if (document.body.contains(element)) document.body.removeChild(element);
    });
    activeTouches.clear();
  }

  function scegliDito() {
    if (activeTouches.size < 2) return;
    const keys = Array.from(activeTouches.keys());
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const idx = array[0] % keys.length;
    const winner = keys[idx];
    activeTouches.forEach((data, id) => {
      if (id !== winner) {
        data.element.style.opacity = '0.3';
      }
    });
    resultFingers.textContent = 'Dito scelto!';
    selectionDone = true;
  }

  function resetTimer() {
    if (selectionTimer || countdownInterval) {
      clearTimer();
    }

    if (activeTouches.size < 2) {
      resultFingers.textContent = 'Appoggia almeno 2 dita per iniziare la scelta.';
      countdownEl.textContent = '';
      return;
    }

    resultFingers.textContent = `Dita poggiate: ${activeTouches.size}. Scelta tra 5 secondi...`;
    let secondsLeft = SELECTION_TIME_MS / 1000;
    countdownEl.textContent = `Tempo rimasto: ${secondsLeft} s`;

    startProgressAnimation();

    countdownInterval = setInterval(() => {
      secondsLeft--;
      countdownEl.textContent = `Tempo rimasto: ${secondsLeft} s`;
      if (secondsLeft <= 0) {
        clearInterval(countdownInterval);
        countdownEl.textContent = '';
        scegliDito();
      }
    }, 1000);

    selectionTimer = setTimeout(() => {
      clearInterval(countdownInterval);
      countdownEl.textContent = '';
      scegliDito();
    }, SELECTION_TIME_MS);
  }

  // Touch Events
  ['touchstart', 'touchend', 'touchcancel'].forEach(eventType => {
    areaTouch.addEventListener(eventType, (e) => {
      if (activeMode !== 'fingers') return;

      if (eventType === 'touchstart' && selectionDone) {
        clearTouchDots();
        resetAllProgressCircles();
        selectionDone = false;
      }

      for (const touch of e.changedTouches) {
        if (eventType === 'touchstart') {
          const dot = document.createElement('div');
          dot.classList.add('dot');
          const colorClass = colors[activeTouches.size % colors.length];
          dot.classList.add(colorClass);
          dot.style.left = (touch.pageX - 35) + 'px';
          dot.style.top = (touch.pageY - 35) + 'px';

          const progressCircle = createProgressCircle();
          dot.appendChild(progressCircle);

          document.body.appendChild(dot);
          activeTouches.set(touch.identifier, {
            x: touch.pageX,
            y: touch.pageY,
            element: dot,
            colorClass,
            progressCircle
          });
        } else {
          const data = activeTouches.get(touch.identifier);
          if (data) {
            document.body.removeChild(data.element);
            activeTouches.delete(touch.identifier);
          }
        }
      }

      const currentTouchCount = activeTouches.size;
      if (currentTouchCount >= 2) {
        if (previousTouchCount !== currentTouchCount) {
          resetTimer();
        }
      } else {
        clearTimer();
        resultFingers.textContent = 'Appoggia almeno 2 dita per iniziare la scelta.';
        countdownEl.textContent = '';
      }
      previousTouchCount = currentTouchCount;

      e.preventDefault();
    }, {passive:false});
  });

  areaTouch.addEventListener('touchmove', (e) => {
    if (activeMode !== 'fingers') return;
    for (const touch of e.changedTouches) {
      const data = activeTouches.get(touch.identifier);
      if (data) {
        data.x = touch.pageX;
        data.y = touch.pageY;
        data.element.style.left = (touch.pageX - 35) + 'px';
        data.element.style.top = (touch.pageY - 35) + 'px';
      }
    }
    e.preventDefault();
  }, {passive:false});

  pickNameBtn.addEventListener('click', () => {
    if (activeMode !== 'names') return;
    const input = document.getElementById('namesInput').value.trim();
    if (!input) {
      resultNames.textContent = 'Inserisci almeno un nome.';
      return;
    }
    const names = input.split(',').map(n => n.trim()).filter(n => n.length > 0);
    if (names.length === 0) {
      resultNames.textContent = 'Inserisci almeno un nome valido.';
      return;
    }
    const array = new Uint32Array(1);
    window.crypto.getRandomValues(array);
    const idx = array[0] % names.length;
    resultNames.textContent = `Nome scelto: ${names[idx]}`;
  });

  setActiveMode('fingers');
</script>

</body>
</html>
